name: Code coverage

on: [ push, pull_request ]

env:
  APT_INSTALL: |
    sudo apt-get install
      -yq --no-install-suggests --no-install-recommends
      --allow-unauthenticated --allow-downgrades --allow-change-held-packages

jobs:
  codecov:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v2

      - uses: lukka/get-cmake@latest

      - name: Create Build Environment
        run: |
          sudo locale-gen en_US.UTF-8
          sudo locale-gen fi_FI.UTF-8
          sudo update-locale
          sudo locale -a
          
          $APT_INSTALL lcov
          
          mkdir ${{ runner.workspace }}/build
          mkdir ${{ runner.workspace }}/report

      - name: Run CMake
        working-directory: ${{ runner.workspace }}/build
        run: |
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Debug \
                -DCMAKE_CXX_STANDARD=20 \
                -DSCN_CI=ON -DSCN_COVERAGE=ON \
                $GITHUB_WORKSPACE

      - name: Generate Coverage Report
        working-directory: ${{ runner.workspace }}/build
        run: |
          cmake --build . --target scn_coverage_script_prepare
          ./coverage.sh
          cp coverage-filtered.info ${{ runner.workspace }}/report/coverage.info

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v3
        with:
          directory: ${{ runner.workspace }}/report
          fail_ci_if_error: true
          verbose: true

